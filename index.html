<head>
<meta charset="utf-8"/>

<style>
body {
    margin: 0;
        padding: 0;

}
</style>
</head>

<body>

<audio id="soundz" src="radioaudio.mp3" autoplay></audio>
<audio id="soundz2" src="untitled.wav" autoplay></audio>
<canvas id="visualizer"></canvas>
<div style="display:none;">
  <img id="lcd_tux" src="lcd_tux.jpg">
</div>
<div style="display:none;">
  <img id="daniel" src="9ef5475a-2e11-439b-b68e-2e1977e6337f.jpg">
</div>


    <script>
var Daniel = {
    colour: "red",
    imageID: "lcd_tux",
    smoothedVol: 0,
};

var Ben = {
    colour: "green",
    imageID: "lcd_tux",
    smoothedVol: 0,
};


var audioCtx = new (window.AudioContext || window.webkitAudioContext)();


function setupAudioAnalyserForPerson(person, trackID) {
    person.analyser = audioCtx.createAnalyser();

    person.audioElement = document.getElementById(trackID);
    person.source = audioCtx.createMediaElementSource(person.audioElement);
    person.source.connect(person.analyser);
    person.analyser.connect(audioCtx.destination);

    person.analyser.fftSize = 2048;
    person.bufferLength = person.analyser.frequencyBinCount;
    person.dataArray = new Float32Array(person.bufferLength);
}

setupAudioAnalyserForPerson(Ben, "soundz");
setupAudioAnalyserForPerson(Daniel, "soundz2");






var canvas = document.getElementById("visualizer");
var canvasCtx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

var WIDTH = canvas.width;
var HEIGHT = canvas.height;
canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

// From http://rosettacode.org/wiki/Map_range#JavaScript
var mapRange = function(from, to, s) {
    return to[0] + (s - from[0]) * (to[1] - to[0]) / (from[1] - from[0]);
};

function drawVisualizer(x, y, width, height, person) {
    person.analyser.getFloatTimeDomainData(person.dataArray);

    canvasCtx.translate(x, y);

    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = person.colour;
    canvasCtx.beginPath();

    var sliceWidth = width * 1.0 / person.bufferLength;
    var x = 0;

    var curVol = 0;

    for (var i = 0; i < person.bufferLength; i++) {
        var v = person.dataArray[i] * 200;
        var y = v + height / 2;

        if (i === 0) {
            canvasCtx.moveTo(x, y);
        } else {
            canvasCtx.lineTo(x, y);
        }

        x += sliceWidth;


        curVol += person.dataArray[i] * person.dataArray[i];
    }

    curVol /= person.bufferLength;
    curVol = Math.sqrt(curVol);

    person.smoothedVol *= 0.80;
    person.smoothedVol += 0.20 * curVol;

    canvasCtx.lineTo(width, height / 2);
    canvasCtx.stroke();



    var image = document.getElementById(person.imageID);

    canvasCtx.drawImage(image, 0, 0);
    canvasCtx.globalCompositeOperation = "saturation";
    console.log(person.smoothedVol);
    canvasCtx.fillStyle = "hsl(0," + mapRange([0.01, 0.1], [0, 100], person.smoothedVol) + "%,50%)";  // saturation at 100%
    canvasCtx.fillRect(0,0,image.width,image.height);  // apply the comp filter
    canvasCtx.globalCompositeOperation = "source-over";  // restore default comp



    canvasCtx.setTransform(1, 0, 0, 1, 0, 0);
}

function draw() {
    drawVisual = requestAnimationFrame(draw);

    canvasCtx.fillStyle = 'rgb(100%, 100%, 100%)';
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);


    drawVisualizer(0, 0, WIDTH/2, HEIGHT, Ben);
    drawVisualizer(WIDTH/2, 0, WIDTH/2, HEIGHT, Daniel);


};

draw();
    </script>
</body>
